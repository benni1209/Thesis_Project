---
title: "assets"
author: "Benedikt Sojka | s4089448"
date: "2025-07-09"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(DescTools)  # For CramerV function

# Function to calculate association measures
calculate_associations <- function(data) {
  xy_assoc <- CramerV(table(data$X, data$Y))
  xz_assoc <- CramerV(table(data$X, data$Z))
  yz_assoc <- CramerV(table(data$Y, data$Z))
  
  # Calculate partial association of Y-Z given X
  # This represents the mediated association through X
  yz_given_x <- numeric()
  for(x_val in unique(data$X)) {
    subset_data <- data[data$X == x_val, ]
    if(nrow(subset_data) > 10) {  # Only calculate if sufficient data
      yz_given_x <- c(yz_given_x, CramerV(table(subset_data$Y, subset_data$Z)))
    }
  }
  yz_partial <- mean(yz_given_x, na.rm = TRUE)
  
  return(list(
    XY = xy_assoc,
    XZ = xz_assoc,
    YZ = yz_assoc,
    YZ_partial = yz_partial
  ))
}

# Function to generate population and sample data
generate_data <- function(
  pop_size = 1000000,       
  sample_A_size = 125000,    
  sample_B_size = 125000,    
  sample_C_size = 7500,    
  scenario = 1,             # 1: baseline (0.11), 2: medium (0.25), 3: strong (0.40)
  seed = 123              
)  {
  set.seed(seed)
  
  # Define scenario parameters
  scenario_params <- list(
    "1" = list(y_effect = 0.0, description = "Baseline: Y-Z fully mediated by X"),
    "2" = list(y_effect = 0.3, description = "Medium: Y-Z partially direct"),
    "3" = list(y_effect = 0.6, description = "Strong: Y-Z mostly direct")
  )
  
  current_scenario <- scenario_params[[as.character(scenario)]]
  y_effect_strength <- current_scenario$y_effect
  scenario_description <- current_scenario$description
  
  # Create the population data frame
  population <- data.frame(
    id = 1:pop_size,
    X = sample(1:6, pop_size, replace = TRUE, prob = c(0.15, 0.15, 0.20, 0.20, 0.15, 0.15))
  )
  
  # Generate Y based on X (unchanged to maintain XY association)
  y_probs_0 <- numeric(pop_size)
  y_probs_1 <- numeric(pop_size)
  y_probs_2 <- numeric(pop_size)
  
  # Set probabilities for each X category
  y_probs_0[population$X == 1] <- 0.6; y_probs_1[population$X == 1] <- 0.3; y_probs_2[population$X == 1] <- 0.1
  y_probs_0[population$X == 2] <- 0.5; y_probs_1[population$X == 2] <- 0.3; y_probs_2[population$X == 2] <- 0.2
  y_probs_0[population$X == 3] <- 0.4; y_probs_1[population$X == 3] <- 0.3; y_probs_2[population$X == 3] <- 0.3
  y_probs_0[population$X == 4] <- 0.3; y_probs_1[population$X == 4] <- 0.3; y_probs_2[population$X == 4] <- 0.4
  y_probs_0[population$X == 5] <- 0.2; y_probs_1[population$X == 5] <- 0.3; y_probs_2[population$X == 5] <- 0.5
  y_probs_0[population$X == 6] <- 0.1; y_probs_1[population$X == 6] <- 0.3; y_probs_2[population$X == 6] <- 0.6
  
  population$Y <- apply(cbind(y_probs_0, y_probs_1, y_probs_2), 1, function(probs) {
    sample(0:2, 1, prob = probs)
  })
  
  # Generate Z based on both X and Y
  z_probs_0 <- numeric(pop_size)
  z_probs_1 <- numeric(pop_size)
  z_probs_2 <- numeric(pop_size)
  
  # Base probabilities for each X category (these create the X-Z association)
  z_base_probs <- matrix(nrow = 6, ncol = 3)
  z_base_probs[1, ] <- c(0.1, 0.3, 0.6)
  z_base_probs[2, ] <- c(0.2, 0.3, 0.5)
  z_base_probs[3, ] <- c(0.3, 0.3, 0.4)
  z_base_probs[4, ] <- c(0.4, 0.3, 0.3)
  z_base_probs[5, ] <- c(0.5, 0.3, 0.2)
  z_base_probs[6, ] <- c(0.6, 0.3, 0.1)
  
  # Apply base probabilities
  for(i in 1:6) {
    idx <- population$X == i
    z_probs_0[idx] <- z_base_probs[i, 1]
    z_probs_1[idx] <- z_base_probs[i, 2]
    z_probs_2[idx] <- z_base_probs[i, 3]
  }
  
  # Add Y effect to create direct Y-Z association
  if(y_effect_strength > 0) {
    # Create Y effect matrix (how Y influences Z probabilities)
    y_effect_matrix <- matrix(0, nrow = 3, ncol = 3)
    
    # When Y=0, increase probability of Z=0
    y_effect_matrix[1, ] <- c(y_effect_strength, 0, -y_effect_strength)
    # When Y=1, increase probability of Z=1
    y_effect_matrix[2, ] <- c(-y_effect_strength/2, y_effect_strength, -y_effect_strength/2)
    # When Y=2, increase probability of Z=2
    y_effect_matrix[3, ] <- c(-y_effect_strength, 0, y_effect_strength)
    
    # Apply Y effects
    for(y_val in 0:2) {
      idx <- population$Y == y_val
      z_probs_0[idx] <- z_probs_0[idx] + y_effect_matrix[y_val + 1, 1]
      z_probs_1[idx] <- z_probs_1[idx] + y_effect_matrix[y_val + 1, 2]
      z_probs_2[idx] <- z_probs_2[idx] + y_effect_matrix[y_val + 1, 3]
    }
    
    # Ensure probabilities are valid (between 0 and 1)
    z_probs_0 <- pmax(0, pmin(1, z_probs_0))
    z_probs_1 <- pmax(0, pmin(1, z_probs_1))
    z_probs_2 <- pmax(0, pmin(1, z_probs_2))
    
    # Normalize to ensure they sum to 1
    z_sum <- z_probs_0 + z_probs_1 + z_probs_2
    z_probs_0 <- z_probs_0 / z_sum
    z_probs_1 <- z_probs_1 / z_sum
    z_probs_2 <- z_probs_2 / z_sum
  }
  
  # Generate Z
  population$Z <- apply(cbind(z_probs_0, z_probs_1, z_probs_2), 1, function(probs) {
    sample(0:2, 1, prob = probs)
  })
  
  # Define selection probabilities for Sample C (non-probability sample)
  # For simplicity, using uniform selection here
  selection_probs <- rep(1, nrow(population))
  
  # Draw Sample C first (non-probability sample)
  sample_C_indices <- sample(1:nrow(population), sample_C_size, replace = FALSE, 
                            prob = selection_probs)
  sample_C <- population[sample_C_indices, c("id", "X", "Y", "Z")]
  
  # Remove Sample C from population
  pop_remaining <- population[-sample_C_indices, ]
  
  # Draw Sample A (probability sample)
  sample_A_indices <- sample(1:nrow(pop_remaining), sample_A_size, replace = FALSE)
  sample_A <- pop_remaining[sample_A_indices, c("id", "X", "Y")]
  
  # Remove Sample A from remaining population
  pop_remaining_B <- pop_remaining[-sample_A_indices, ]
  
  # Draw Sample B (probability sample)
  sample_B_indices <- sample(1:nrow(pop_remaining_B), sample_B_size, replace = FALSE)
  sample_B <- pop_remaining_B[sample_B_indices, c("id", "X", "Z")]
  
  # Calculate associations in the population
  pop_associations <- calculate_associations(population)
  
  return(list(
    population = population,
    sample_A = sample_A,
    sample_B = sample_B,
    sample_C = sample_C,
    scenario = scenario,
    scenario_description = scenario_description,
    y_effect_strength = y_effect_strength,
    selection_probs = selection_probs,
    population_associations = pop_associations
  ))
}

# Test the three scenarios
test_scenarios <- function() {
  for(sc in 1:3) {
    cat("\n============ Scenario", sc, "============\n")
    data <- generate_data(scenario = sc, seed = 123)
    
    cat("Description:", data$scenario_description, "\n")
    cat("Y effect strength:", data$y_effect_strength, "\n\n")
    
    cat("Population associations:\n")
    cat("X-Y association:", round(data$population_associations$XY, 3), "\n")
    cat("X-Z association:", round(data$population_associations$XZ, 3), "\n")
    cat("Y-Z association:", round(data$population_associations$YZ, 3), "\n")
    cat("Y-Z partial (given X):", round(data$population_associations$YZ_partial, 3), "\n")
  }
}

# Run the test
test_scenarios()
```

